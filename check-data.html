<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NDT Suite - Data Diagnostic</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #252526;
            border-radius: 4px;
        }
        h2 {
            color: #4ec9b0;
            margin-top: 0;
        }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #1177bb;
        }
        .error {
            color: #f48771;
        }
        .success {
            color: #4ec9b0;
        }
        .warning {
            color: #dcdcaa;
        }
    </style>
</head>
<body>
    <h1>NDT Suite Data Diagnostic Tool</h1>

    <div class="section">
        <h2>IndexedDB Contents</h2>
        <button class="button" onclick="checkIndexedDB()">Check IndexedDB</button>
        <button class="button" onclick="viewAllOrgs()">View All Organizations</button>
        <div id="indexedDBResult"></div>
    </div>

    <div class="section">
        <h2>Current User & Organization</h2>
        <button class="button" onclick="checkAuthStatus()">Check Auth Status</button>
        <div id="authResult"></div>
    </div>

    <div class="section">
        <h2>Supabase Configuration</h2>
        <button class="button" onclick="checkSupabaseConfig()">Check Supabase Config</button>
        <div id="supabaseResult"></div>
    </div>

    <div class="section">
        <h2>Data Export</h2>
        <button class="button" onclick="exportAllData()">Export All Data (JSON)</button>
        <button class="button" onclick="exportOrgData()">Export Current Org Data</button>
        <div id="exportResult"></div>
    </div>

    <script type="module">
        // Import the modules
        import indexedDB from './src/indexed-db.js';
        import authManager from './src/auth-manager.js';
        import dataManager from './src/data-manager.js';
        import { isSupabaseConfigured } from './src/supabase-client.js';

        // Make them globally available for the buttons
        window.indexedDB_wrapper = indexedDB;
        window.authManager = authManager;
        window.dataManager = dataManager;
        window.isSupabaseConfigured = isSupabaseConfigured;

        // Auto-run checks on load
        window.addEventListener('load', async () => {
            await checkIndexedDB();
            await checkAuthStatus();
            await checkSupabaseConfig();
        });

        window.checkIndexedDB = async function() {
            const result = document.getElementById('indexedDBResult');
            result.innerHTML = '<p>Loading...</p>';

            try {
                const data = await window.indexedDB_wrapper.loadData();

                let html = '<h3>Raw Data Structure:</h3>';
                html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';

                html += '<h3>Summary:</h3>';
                html += '<ul>';

                if (Object.keys(data).length === 0) {
                    html += '<li class="warning">⚠️ No data found in IndexedDB</li>';
                } else {
                    // Check if old format (has 'assets' key directly)
                    if (data.assets) {
                        html += '<li class="warning">⚠️ Old format detected (not organization-scoped)</li>';
                        html += '<li>Assets: ' + data.assets.length + '</li>';
                    } else {
                        // New format (organization-scoped)
                        const orgCount = Object.keys(data).length;
                        html += '<li class="success">✓ Organization-scoped format</li>';
                        html += '<li>Organizations in local data: ' + orgCount + '</li>';

                        for (const orgId in data) {
                            const orgData = data[orgId];
                            const assetCount = orgData.assets ? orgData.assets.length : 0;
                            let totalScans = 0;
                            let totalVessels = 0;

                            if (orgData.assets) {
                                for (const asset of orgData.assets) {
                                    totalVessels += asset.vessels ? asset.vessels.length : 0;
                                    for (const vessel of (asset.vessels || [])) {
                                        totalScans += vessel.scans ? vessel.scans.length : 0;
                                    }
                                }
                            }

                            html += '<li><strong>Org ID: ' + orgId + '</strong>';
                            html += '<ul>';
                            html += '<li>Assets: ' + assetCount + '</li>';
                            html += '<li>Vessels: ' + totalVessels + '</li>';
                            html += '<li>Scans: ' + totalScans + '</li>';
                            html += '</ul></li>';
                        }
                    }
                }

                html += '</ul>';
                result.innerHTML = html;

            } catch (error) {
                result.innerHTML = '<p class="error">Error: ' + error.message + '</p>';
            }
        };

        window.viewAllOrgs = async function() {
            const result = document.getElementById('indexedDBResult');
            result.innerHTML = '<p>Loading organization details...</p>';

            try {
                const data = await window.indexedDB_wrapper.loadData();

                let html = '<h3>Detailed Organization Data:</h3>';

                if (data.assets) {
                    html += '<p class="warning">Data is in old format (not organization-scoped)</p>';
                } else {
                    for (const orgId in data) {
                        html += '<div style="margin: 10px 0; padding: 10px; background: #1e1e1e; border-radius: 4px;">';
                        html += '<h4>Organization: ' + orgId + '</h4>';

                        const orgData = data[orgId];
                        if (orgData.assets && orgData.assets.length > 0) {
                            html += '<ul>';
                            for (const asset of orgData.assets) {
                                html += '<li><strong>' + asset.name + '</strong> (ID: ' + asset.id + ')';
                                html += '<ul>';
                                for (const vessel of (asset.vessels || [])) {
                                    html += '<li>' + vessel.name + ' - ' + (vessel.scans ? vessel.scans.length : 0) + ' scans</li>';
                                }
                                html += '</ul></li>';
                            }
                            html += '</ul>';
                        } else {
                            html += '<p class="warning">No assets in this organization</p>';
                        }
                        html += '</div>';
                    }
                }

                result.innerHTML = html;
            } catch (error) {
                result.innerHTML = '<p class="error">Error: ' + error.message + '</p>';
            }
        };

        window.checkAuthStatus = async function() {
            const result = document.getElementById('authResult');
            result.innerHTML = '<p>Loading...</p>';

            try {
                await window.authManager.ensureInitialized();

                const user = window.authManager.getCurrentUser();
                const orgId = window.authManager.getCurrentOrganizationId();
                const isLoggedIn = window.authManager.isLoggedIn();
                const useSupabase = window.authManager.useSupabase;

                let html = '<ul>';
                html += '<li>Logged In: <span class="' + (isLoggedIn ? 'success' : 'error') + '">' + isLoggedIn + '</span></li>';
                html += '<li>Using Supabase: <span class="' + (useSupabase ? 'success' : 'warning') + '">' + useSupabase + '</span></li>';
                html += '<li>Current User: ' + (user ? user.email : '<span class="error">None</span>') + '</li>';
                html += '<li>Current Organization ID: ' + (orgId ? orgId : '<span class="error">None</span>') + '</li>';

                if (user) {
                    html += '<li>User Details: <pre>' + JSON.stringify(user, null, 2) + '</pre></li>';
                }

                html += '</ul>';

                if (!isLoggedIn) {
                    html += '<p class="warning">⚠️ You are not logged in. This is why you might not see your work data!</p>';
                }

                if (!orgId) {
                    html += '<p class="warning">⚠️ No organization context set. Data is organization-scoped!</p>';
                }

                result.innerHTML = html;

            } catch (error) {
                result.innerHTML = '<p class="error">Error: ' + error.message + '</p>';
            }
        };

        window.checkSupabaseConfig = async function() {
            const result = document.getElementById('supabaseResult');
            result.innerHTML = '<p>Loading...</p>';

            try {
                const configured = window.isSupabaseConfigured();

                let html = '<ul>';
                html += '<li>Supabase Configured: <span class="' + (configured ? 'success' : 'error') + '">' + configured + '</span></li>';

                if (configured) {
                    const url = import.meta.env.VITE_SUPABASE_URL;
                    html += '<li>Supabase URL: ' + url + '</li>';
                    html += '<li class="success">✓ Supabase credentials are set</li>';
                } else {
                    html += '<li class="error">✗ Supabase credentials are NOT set or invalid</li>';
                }

                html += '</ul>';
                result.innerHTML = html;

            } catch (error) {
                result.innerHTML = '<p class="error">Error: ' + error.message + '</p>';
            }
        };

        window.exportAllData = async function() {
            const result = document.getElementById('exportResult');

            try {
                const data = await window.indexedDB_wrapper.loadData();
                const json = JSON.stringify(data, null, 2);

                // Create download
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ndt-suite-all-data-' + new Date().toISOString().split('T')[0] + '.json';
                a.click();

                result.innerHTML = '<p class="success">✓ All data exported successfully</p>';
            } catch (error) {
                result.innerHTML = '<p class="error">Error: ' + error.message + '</p>';
            }
        };

        window.exportOrgData = async function() {
            const result = document.getElementById('exportResult');

            try {
                await window.authManager.ensureInitialized();
                const orgId = window.authManager.getCurrentOrganizationId();

                if (!orgId) {
                    result.innerHTML = '<p class="error">No organization context set. Cannot export organization data.</p>';
                    return;
                }

                const data = await window.indexedDB_wrapper.loadData();
                const orgData = data[orgId] || { assets: [] };
                const json = JSON.stringify(orgData, null, 2);

                // Create download
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ndt-suite-org-' + orgId + '-' + new Date().toISOString().split('T')[0] + '.json';
                a.click();

                result.innerHTML = '<p class="success">✓ Organization data exported successfully</p>';
            } catch (error) {
                result.innerHTML = '<p class="error">Error: ' + error.message + '</p>';
            }
        };
    </script>
</body>
</html>
